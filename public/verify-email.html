<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - Klicktape</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #000000, #1a1a1a, #2a2a2a);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            text-align: center;
            max-width: 400px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        .logo {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
        }
        .message {
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.5;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ff6b6b;
            margin-top: 20px;
        }
        .success {
            color: #4CAF50;
            margin-top: 20px;
        }
        .manual-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #FFD700;
            color: #000;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
        }
        .debug-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 12px;
            text-align: left;
            overflow-wrap: break-word;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">Klicktape</div>
        
        <div id="loading-state">
            <div class="message">
                Verifying your email...
            </div>
            <div class="spinner"></div>
        </div>

        <div id="success-state" style="display: none;">
            <div class="success">
                ‚úÖ Email Confirmed Successfully!
            </div>
            <div class="message">
                Congratulations! Your email address has been confirmed and your account is now active.
                <br><br>
                You will be automatically redirected to the Klicktape app in a few seconds.
            </div>
            <div class="message">
                <strong>If the app doesn't open automatically:</strong>
                <br>
                1. Open the Klicktape app on your device
                <br>
                2. Sign in with your email and password
                <br>
                3. Start exploring Klicktape!
            </div>
        </div>

        <div id="error-state" style="display: none;">
            <div class="error">
                ‚ùå Email Verification Failed
            </div>
            <div id="error-message" class="message">
                <!-- Error message will be inserted here -->
            </div>
        </div>

        <div id="debug-info" class="debug-info">
            <strong>Debug Info:</strong>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
        function getUrlParams() {
            const hash = window.location.hash;
            const hashParts = hash.split('#').filter(part => part.length > 0);
            
            console.log('Hash parts:', hashParts);
            
            // Look for the hash that contains verification parameters
            let supabaseHash = '';
            let fallbackHash = '';
            
            for (const part of hashParts) {
                const params = new URLSearchParams(part);
                const accessToken = params.get('access_token');
                const type = params.get('type');
                
                if (type === 'signup' || (accessToken && accessToken.startsWith('ey'))) {
                    supabaseHash = part;
                    break;
                } else if (accessToken) {
                    fallbackHash = part;
                }
            }
            
            const hashToUse = supabaseHash || fallbackHash || hashParts[hashParts.length - 1] || '';
            console.log('Using hash:', hashToUse);
            
            const hashParams = new URLSearchParams(hashToUse);
            const queryParams = new URLSearchParams(window.location.search);

            const params = {
                access_token: hashParams.get('access_token') || queryParams.get('access_token'),
                refresh_token: hashParams.get('refresh_token') || queryParams.get('refresh_token'),
                error: hashParams.get('error') || queryParams.get('error'),
                error_description: hashParams.get('error_description') || queryParams.get('error_description'),
                type: hashParams.get('type') || queryParams.get('type'),
                expires_at: hashParams.get('expires_at') || queryParams.get('expires_at'),
                expires_in: hashParams.get('expires_in') || queryParams.get('expires_in'),
                token_type: hashParams.get('token_type') || queryParams.get('token_type')
            };

            console.log('Parsed params:', params);
            
            // Debug info
            const debugInfo = document.getElementById('debug-content');
            if (debugInfo) {
                debugInfo.innerHTML = `
                    Full URL: ${window.location.href}<br>
                    Hash parts count: ${hashParts.length}<br>
                    Selected hash: ${hashToUse.substring(0, 100)}${hashToUse.length > 100 ? '...' : ''}<br>
                    Access token starts with: ${params.access_token ? params.access_token.substring(0, 20) + '...' : 'null'}<br>
                    Has refresh token: ${!!params.refresh_token}<br>
                    Type: ${params.type}<br>
                    Error: ${params.error || 'none'}
                `;
            }
            
            return params;
        }

        function showError(message) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            
            const errorMessageDiv = document.getElementById('error-message');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = message; // Safe - prevents XSS by not executing HTML/JS
            }
            
            document.getElementById('debug-info').style.display = 'block';
        }

        function showSuccess() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'block';
            document.getElementById('debug-info').style.display = 'none';
        }

        async function completeReferralAfterVerification() {
            try {
                console.log('üéØ Attempting to complete referral after email verification');
                
                // Check if there's a pending referral code in localStorage
                const pendingReferralCode = localStorage.getItem('pendingReferralCode');
                
                if (pendingReferralCode) {
                    console.log('üéØ Found pending referral code:', pendingReferralCode);
                    
                    // Get user info from the access token if available
                    const params = getUrlParams();
                    let userId = null;
                    
                    if (params.access_token) {
                        try {
                            // Try to get user info from Supabase
                            const response = await fetch('https://api.klicktape.com/auth/v1/user', {
                                headers: {
                                    'Authorization': `Bearer ${params.access_token}`,
                                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweGtqcWZjb3VkY2RkbHVpaWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzYzMjAsImV4cCI6MjA2ODc1MjMyMH0.jHHkzKzg9oqysBOY7ohIa-6iveAOnF_FOvCsGV18MCU'
                                }
                            });
                            
                            if (response.ok) {
                                const userData = await response.json();
                                userId = userData.id;
                            }
                        } catch (error) {
                            console.warn('Could not fetch user data for referral completion:', error);
                        }
                    }
                    
                    if (userId) {
                        // Call the referral completion API
                        const referralResponse = await fetch('https://api.klicktape.com/rest/v1/referrals', {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${params.access_token}`,
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndweGtqcWZjb3VkY2RkbHVpaWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNzYzMjAsImV4cCI6MjA2ODc1MjMyMH0.jHHkzKzg9oqysBOY7ohIa-6iveAOnF_FOvCsGV18MCU',
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({
                                referred_user_id: userId,
                                status: 'completed',
                                registered_at: new Date().toISOString(),
                                completed_at: new Date().toISOString()
                            })
                        });
                        
                        if (referralResponse.ok) {
                            const referralData = await referralResponse.json();
                            if (referralData && referralData.length > 0) {
                                console.log('‚úÖ Referral completed successfully:', referralData[0]);
                                // Clear the pending referral code
                                localStorage.removeItem('pendingReferralCode');
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Referral completion failed:', await referralResponse.text());
                        }
                    } else {
                        console.log('‚ÑπÔ∏è Could not determine user ID for referral completion');
                    }
                } else {
                    console.log('‚ÑπÔ∏è No pending referral code found');
                }
            } catch (error) {
                console.error('‚ùå Error completing referral:', error);
            }
        }

        async function verifyEmail() {
            const params = getUrlParams();
            console.log('URL params:', params);

            // Check for errors first
            if (params.error) {
                console.error('Auth error:', params.error, params.error_description);
                
                let errorMessage = 'Email verification failed.';
                if (params.error === 'access_denied') {
                    if (params.error_description && params.error_description.includes('expired')) {
                        errorMessage = 'This email verification link has expired. Please request a new verification email.';
                    } else {
                        errorMessage = 'Email verification link is invalid or has expired.';
                    }
                }
                
                showError(errorMessage + '<br><br>Please go back to the app and request a new verification email if needed.');
                return;
            }

            // Check if this is a signup verification with access token
            if (params.type === 'signup' && params.access_token) {
                console.log('Email verification successful - confirming with Supabase');
                
                try {
                    // Verify the token with Supabase to ensure it's valid
                    const response = await fetch('https://api.klicktape.com/auth/v1/user', {
                        headers: {
                            'Authorization': `Bearer ${params.access_token}`,
                            'apikey': 'your-anon-key' // This should be replaced with actual anon key
                        }
                    });

                    if (response.ok) {
                        console.log('‚úÖ Email verification confirmed with Supabase');
                        
                        // Complete referral if applicable
                        await completeReferralAfterVerification();
                        
                        showSuccess();
                        
                        // Try to redirect to app after showing success message
                        setTimeout(() => {
                            redirectToApp();
                        }, 3000);
                    } else {
                        throw new Error('Invalid verification token');
                    }
                } catch (error) {
                    console.error('Error verifying token:', error);
                    // Still show success if we have the right parameters, as the email link was clicked
                    await completeReferralAfterVerification();
                    showSuccess();
                    setTimeout(() => {
                        redirectToApp();
                    }, 3000);
                }
                
                return;
            }

            // Check if this is a signup verification without access token (older format)
            if (params.type === 'signup') {
                console.log('Email verification successful (legacy format)');
                await completeReferralAfterVerification();
                showSuccess();
                
                setTimeout(() => {
                    redirectToApp();
                }, 3000);
                
                return;
            }

            // If we have an access token but no type, assume it's a valid verification
            if (params.access_token) {
                console.log('Email verification successful (access token present)');
                await completeReferralAfterVerification();
                showSuccess();
                
                setTimeout(() => {
                    redirectToApp();
                }, 3000);
                
                return;
            }

            // If no verification data found, show error
            showError('Invalid verification link. No verification data found.<br><br>Please check your email for the correct verification link or request a new one from the app.');
        }

        function redirectToApp() {
            const appUrl = 'klicktape://auth/verified';
            const expoUrl = 'exp://192.168.31.241:8081/--/auth/verified';
            
            console.log('Attempting to redirect to app...');
            
            // Try app scheme first
            window.location.href = appUrl;
            
            // Fallback to expo URL for development after a short delay
            setTimeout(() => {
                window.location.href = expoUrl;
            }, 1000);
            
            // If neither works, show manual instructions after 3 seconds
            setTimeout(() => {
                const manualInstructions = document.createElement('div');
                manualInstructions.innerHTML = `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 8px;">
                        <strong>Unable to automatically open the app?</strong><br>
                        Please manually open the Klicktape app on your device and log in with your credentials.
                    </div>
                `;
                document.querySelector('.container').appendChild(manualInstructions);
            }, 3000);
        }

        // Start verification when page loads
        window.addEventListener('load', verifyEmail);
    </script>
</body>
</html>
